{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "14363275772519941434"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "environmentId": {
      "type": "string"
    },
    "acrName": {
      "type": "string"
    },
    "grafanaName": {
      "type": "string"
    },
    "grafanaEndpoint": {
      "type": "string"
    },
    "appName": {
      "type": "string",
      "defaultValue": "ca-mcp-amg",
      "metadata": {
        "description": "Name of the Container App to deploy (use a different name like ca-mcp-amg-debug for diagnostics without impacting the primary app)."
      }
    },
    "ingressEnabled": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "When false, deploy without ingress (avoids port-based startup checks so you can inspect runtime behavior even if nothing is listening on 8000)."
      }
    },
    "debugHold": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, run amg-mcp under a shell wrapper and keep the container alive for debugging (prints logs then sleeps)."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "uami-mcp-amg",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2023-05-01",
      "name": "[parameters('appName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[parameters('environmentId')]",
        "configuration": "[shallowMerge(createArray(union(createObject('registries', createArray(createObject('server', format('{0}.azurecr.io', parameters('acrName')), 'identity', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg')))), if(parameters('ingressEnabled'), createObject('ingress', createObject('external', true(), 'targetPort', 8000, 'transport', 'http', 'corsPolicy', createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'OPTIONS'), 'allowedHeaders', createArray('*')))), createObject()))))]",
        "template": {
          "containers": [
            "[if(parameters('debugHold'), createObject('name', 'amg-mcp', 'image', format('{0}.azurecr.io/amg-mcp:latest', parameters('acrName')), 'command', createArray('/bin/sh'), 'args', createArray('-lc', format('set -eux; echo \"[amg-mcp] wrapper starting\"; uname -a; id; ls -la /usr/local/bin/amg-mcp; echo \"[amg-mcp] env snapshot\"; env | sort | sed -n \"1,120p\"; dump_ports(){{ echo \"[amg-mcp] /proc/net/tcp* (first 60 lines)\"; (cat /proc/net/tcp /proc/net/tcp6 2>/dev/null || true) | sed -n \"1,60p\"; echo \"[amg-mcp] matches for :8000 (hex :1F40)\"; (cat /proc/net/tcp /proc/net/tcp6 2>/dev/null || true) | grep -E \":1F40\" | head -n 20 || true; }}; dump_ports; echo \"[amg-mcp] starting amg-mcp (background)\"; /usr/local/bin/amg-mcp --AmgMcpOptions:Transport=Sse --AmgMcpOptions:SseListenAddress=http://0.0.0.0:8000 --AmgMcpOptions:AzureManagedGrafanaEndpoint=\"{0}\" 2>&1 & pid=$!; sleep 2; echo \"[amg-mcp] after 2s (pid=$pid)\"; dump_ports; echo \"[amg-mcp] monitoring ports for 60s\"; for i in 1 2 3 4 5 6 7 8 9 10 11 12; do sleep 5; echo \"[amg-mcp] t=$((i*5))s\"; dump_ports; done; echo \"[amg-mcp] waiting for amg-mcp pid=$pid\"; wait \"$pid\"; ec=$?; echo \"[amg-mcp] exited code=$ec\"; sleep 3600', parameters('grafanaEndpoint'))), 'env', createArray(createObject('name', 'AmgMcpOptions__AzureManagedGrafanaEndpoint', 'value', parameters('grafanaEndpoint')), createObject('name', 'AZURE_CLIENT_ID', 'value', reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), '2023-01-31').clientId), createObject('name', 'ASPNETCORE_URLS', 'value', 'http://+:8000')), 'resources', createObject('cpu', json('0.25'), 'memory', '0.5Gi')), createObject('name', 'amg-mcp', 'image', format('{0}.azurecr.io/amg-mcp:latest', parameters('acrName')), 'command', createArray('/bin/sh'), 'args', createArray('-lc', format('set -eu; while true; do echo \"[amg-mcp] starting (stdio transport)\"; tail -f /dev/null | /usr/local/bin/amg-mcp --AmgMcpOptions:Transport=Stdio --AmgMcpOptions:AzureManagedGrafanaEndpoint=\"{0}\" 2>&1; ec=$?; echo \"[amg-mcp] exited code=$ec\"; sleep 1; done', parameters('grafanaEndpoint'))), 'env', createArray(createObject('name', 'AmgMcpOptions__AzureManagedGrafanaEndpoint', 'value', parameters('grafanaEndpoint')), createObject('name', 'AZURE_CLIENT_ID', 'value', reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), '2023-01-31').clientId)), 'resources', createObject('cpu', json('0.25'), 'memory', '0.5Gi')))]"
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 1
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg')]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), 'acrpull')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg')]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[resourceId('Microsoft.Dashboard/grafana', parameters('grafanaName'))]",
      "name": "[guid(resourceId('Microsoft.Dashboard/grafana', parameters('grafanaName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), 'grafanaviewer')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '60921a7e-fef1-4a43-9b16-a26c52ad4769')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg')]"
      ]
    }
  ],
  "outputs": {
    "mcpAmgSseUrl": {
      "type": "string",
      "value": "[if(parameters('ingressEnabled'), format('https://{0}/sse', reference(resourceId('Microsoft.App/containerApps', parameters('appName')), '2023-05-01').configuration.ingress.fqdn), '')]"
    },
    "mcpAmgPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', 'uami-mcp-amg'), '2023-01-31').principalId]"
    }
  }
}
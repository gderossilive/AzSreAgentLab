{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "2345916271776802837"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for the Scheduled Query Rule resource (must be a supported Azure region; cannot be global)."
      }
    },
    "apiContainerAppName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Grocery API Container App (e.g., ca-api-xxxx)."
      }
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the Log Analytics workspace where Container Apps logs are stored."
      }
    },
    "actionGroupResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional: existing Action Group resource ID to notify (leave empty for no notifications)."
      }
    },
    "alertEmailAddress": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional: email address for a new Action Group receiver (leave empty to skip creating an Action Group)."
      }
    },
    "evaluationFrequency": {
      "type": "string",
      "defaultValue": "PT1M",
      "metadata": {
        "description": "Alert evaluation frequency (ISO 8601 duration)."
      }
    },
    "windowSize": {
      "type": "string",
      "defaultValue": "PT5M",
      "metadata": {
        "description": "Alert window size (ISO 8601 duration)."
      }
    },
    "threshold": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Threshold for number of matching log entries in the window."
      }
    },
    "severity": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Severity (0-4). 0 is most severe."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "demo": "grocery-sre-demo",
        "managedBy": "bicep"
      },
      "metadata": {
        "description": "Tags to apply to alert resources."
      }
    }
  },
  "variables": {
    "shouldCreateActionGroup": "[not(empty(parameters('alertEmailAddress')))]",
    "actionGroupIds": "[if(not(empty(parameters('actionGroupResourceId'))), createArray(parameters('actionGroupResourceId')), if(variables('shouldCreateActionGroup'), createArray(resourceId('Microsoft.Insights/actionGroups', 'ag-grocery-sre-demo')), createArray()))]",
    "kqlQuery": "ContainerAppConsoleLogs\n| extend caName = coalesce(tostring(column_ifexists(\"ContainerAppName\", \"\")), tostring(column_ifexists(\"ContainerAppName_s\", \"\")))\n| where caName == \"${apiContainerAppName}\"\n| extend msg = coalesce(tostring(column_ifexists(\"Log_s\", \"\")), tostring(column_ifexists(\"Log\", \"\")), tostring(column_ifexists(\"Message\", \"\")))\n| where msg has \"SUPPLIER_RATE_LIMIT_429\"\n"
  },
  "resources": [
    {
      "condition": "[variables('shouldCreateActionGroup')]",
      "type": "Microsoft.Insights/actionGroups",
      "apiVersion": "2023-01-01",
      "name": "ag-grocery-sre-demo",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "groupShortName": "grocerySRE",
        "enabled": true,
        "emailReceivers": [
          {
            "name": "primary-email",
            "emailAddress": "[parameters('alertEmailAddress')]",
            "useCommonAlertSchema": true
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/scheduledQueryRules",
      "apiVersion": "2023-12-01",
      "name": "Grocery API - Supplier rate limit (SUPPLIER_RATE_LIMIT_429)",
      "location": "[parameters('location')]",
      "kind": "LogAlert",
      "tags": "[parameters('tags')]",
      "properties": {
        "displayName": "Grocery API - Supplier rate limit (SUPPLIER_RATE_LIMIT_429)",
        "description": "Fires when the Grocery API logs supplier rate limit events (SUPPLIER_RATE_LIMIT_429).",
        "enabled": true,
        "severity": "[parameters('severity')]",
        "evaluationFrequency": "[parameters('evaluationFrequency')]",
        "windowSize": "[parameters('windowSize')]",
        "scopes": [
          "[parameters('logAnalyticsWorkspaceResourceId')]"
        ],
        "skipQueryValidation": true,
        "criteria": {
          "allOf": [
            {
              "query": "[variables('kqlQuery')]",
              "timeAggregation": "Count",
              "operator": "GreaterThanOrEqual",
              "threshold": "[parameters('threshold')]",
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        },
        "actions": {
          "actionGroups": "[variables('actionGroupIds')]",
          "customProperties": {
            "demo": "grocery-sre-demo",
            "signal": "SUPPLIER_RATE_LIMIT_429",
            "apiContainerAppName": "[parameters('apiContainerAppName')]"
          }
        },
        "autoMitigate": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', 'ag-grocery-sre-demo')]"
      ]
    }
  ],
  "outputs": {
    "scheduledQueryRuleId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/scheduledQueryRules', 'Grocery API - Supplier rate limit (SUPPLIER_RATE_LIMIT_429)')]"
    },
    "actionGroupId": {
      "type": "string",
      "value": "[if(variables('shouldCreateActionGroup'), resourceId('Microsoft.Insights/actionGroups', 'ag-grocery-sre-demo'), parameters('actionGroupResourceId'))]"
    }
  }
}